%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%                                                                     %%%%%
%%%%% Funções e Ajustes dos Documentos do Dicionário                      %%%%%
%%%%%                                                                     %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%% Espaçamento das linhas normal
\SingleSpacing

%%% Hyperref em modo 'draft' não gera os hiperlinks
\hypersetup{final}

%%% Largura da entrada do verbete
\def\entrywidth{.49\textwidth}

%%% Estilo do capítulo, o melhor que encontrei
\chapterstyle{verville}

%%% Sem identação
\setlength{\parindent}{0cm}
\setlength{\parskip}{0.6\baselineskip}

%%% Ajuste das margens do documento
\setlrmarginsandblock{3cm}{2cm}{*}
\setulmarginsandblock{2cm}{*}{1}
\checkandfixthelayout

%%% Pra evitar viúvas e órfãs
\clubpenalty=10000
\widowpenalty=10000
\raggedbottom

%%% Usando a fonte NoTofu do Google.
\babelfont{rm}[
 Renderer=Node,
 Ligatures=TeX,
 BoldFont={NotoSerifCJKsc-SemiBold},
 BoldSlantedFont={NotoSerifCJKsc-SemiBold},
 AutoFakeSlant=0.25,
 SlantedFeatures={FakeSlant=0.25},
 BoldSlantedFeatures={FakeSlant=0.25}]
 {Noto Serif CJK SC Light}
\babelfont{sf}[Renderer=Harfbuzz,Ligatures=TeX]{Noto Sans CJK SC Light}
\babelfont{tt}[Renderer=Harfbuzz,Ligatures=TeX]{Noto Sans Mono CJK SC}

%%% Ajustes do MultiCol: parar com a indentação do primeiro parágrafo
\AddToHook{env/multicols/begin}{\AddToHookNext{para/begin}{\OmitIndent}}

%%% Ajustes do Sumário
\makeatletter
\renewcommand{\@pnumwidth}{2em} 
\renewcommand{\@tocrmarg}{4em}
\makeatother
\renewcommand\cftbeforechapterskip{5pt plus 1pt}

%%% Ajustes da separação das colunas quando em modo texto de 2 colunas
\setlength{\columnsep}{0.8em}
\setlength{\columnseprule}{0.1mm}

%%% Ajustes para o "stackengine"
\renewcommand\stacktype{S}
\renewcommand\stackalignment{c}

%%% Ajustes de Cabeçalhos e Rodapés
\setheadfoot{14pt}{28pt}

% Estilo "plain"
\makefootrule{plain}{\textwidth}{\normalrulethickness}{2pt}
\ifdraftdoc
 \makeevenfoot{plain}{\thepage}{汉葡词典}{Draft}
 \makeoddfoot{plain}{Draft}{汉葡词典}{\thepage}
\else
 \makeevenfoot{plain}{\thepage}{汉葡词典}{}
 \makeoddfoot{plain}{}{汉葡词典}{\thepage}
\fi

% Estilo "dictionary"
\makepagestyle{dictionary}
\makeheadrule{dictionary}{\textwidth}{\normalrulethickness}
\makefootrule{dictionary}{\textwidth}{\normalrulethickness}{2pt}
\ifdraftdoc
 \makeevenhead{dictionary}{\rightmark}{Draft}{\leftmark}
 \makeoddhead{dictionary}{\rightmark}{Draft}{\leftmark}
 \makeevenfoot{dictionary}{\thepage}{汉葡词典}{Draft}
 \makeoddfoot{dictionary}{Draft}{汉葡词典}{\thepage}
\else
 \makeevenhead{dictionary}{\rightmark}{}{\leftmark}
 \makeoddhead{dictionary}{\rightmark}{}{\leftmark}
 \makeevenfoot{dictionary}{\thepage}{汉葡词典}{}
 \makeoddfoot{dictionary}{}{汉葡词典}{\thepage}
\fi

%%% Estilo das Seções
\newcommand{\boxedsec}[1]
 {%
  \begin{tcolorbox}%
   [%
    enhanced,%
    nobeforeafter,%
    before={\noindent},%
    colframe=black,%
    colback=black!15!white,%
    boxrule=2pt,%
    leftrule=2mm,%
    left=0mm,%
    right=0mm,%
    top=0mm,%
    bottom=0mm%
   ]
   \hfill\LARGE\bfseries#1
  \end{tcolorbox}
 }
\setsecheadstyle{\boxedsec}
\setbeforesecskip{1ex plus .25ex minus .25ex}
\setaftersecskip{.25ex plus .25ex minus .25ex}
\newcommand{\sectionbreak}{\phantomsection}

%%% Estilo das caixas dos verbetes
\newtcolorbox{lightbox}%
 {%
  enhanced,%
  size=fbox,%
  colframe=black,%
  colback=white,%
  boxrule=1pt,%
  toprule=3pt,%
  left=0mm,%
  right=0mm,%
  top=0mm,%
  bottom=0mm,%
  middle=0mm,%
  nobeforeafter,%
  segmentation empty,%
  before={\noindent}%
 }
\newtcolorbox{darkbox}%
 {%
  enhanced,%
  size=fbox,%
  colframe=black,%
  colback=black!5!white,%
  boxrule=1pt,%
  toprule=3pt,%
  left=0mm,%
  right=0mm,%
  top=0mm,%
  bottom=0mm,%
  middle=0mm,%
  nobeforeafter,%
  segmentation empty,%
  before={\noindent}%
 }


%%% Variáveis tipo "bool" para dizer se tem ou não os campos
%%% "Veja" e "Veja também" nas definições dos verbetes
\newbool{f_see}
\newbool{f_seealso}

%%% Converte os pinyins numéricos em pinyins com marcação de tom
\directlua{dofile "include/tex-sx-pinyin-tonemarks.lua"}

%%% Comandos genéricos usados no Dicionário

% Função "\pinyin" faz a conversão
\protected\def\pinyin#1{%
 \directlua{packagedata.pinyintones.convert ([==[#1]==])}%
}

% Comando "\dictpinyin", coloca o pinyin entre «»
\NewDocumentCommand{\dictpinyin}{m}{\guillemotleft\pinyin{#1}\guillemotright} 

% Comando "\dpy", gera a string do pinyin utilizada no Dicionário
% Este comando realiza uma série de substituições antes
\NewDocumentCommand{\dpy}{m}%
 {%
  \StrSubstitute{#1}{5}{}[\result]%
  \StrSubstitute{\result}{v}{ü}[\result]%
  \StrSubstitute{\result}{V}{Ü}[\result]%
  \edef\py{\dictpinyin{\result}}%
  \mbox{}\py
 }

% Comando "\&", insere o caracgter "&"
\DeclareRobustCommand{\&}%
 {%
  \ifdim\fontdimen1\font>0pt%
   \textsl{\symbol{`\&}}%
  \else%
   \symbol{`\&}%
  \fi%
 }

% Comando "\dul{text}", sublinha o texto dado
\NewDocumentCommand{\dul}{m}{\underline{#1}}

% Ambiente "enumerate" especial utilizado no dicionário, coloca as definições 
% do verbete em uma lista numerada em linha
\NewDocumentCommand{\dictenumerate}{>{\SplitList{|}}m}
 {%
  \begin{enumerate*}[nosep,label=(\arabic*),left=0pt,mode=unboxed,font=\bfseries]
   \ProcessList{#1}{\insertitem}
  \end{enumerate*}
 }
\NewDocumentCommand{\insertitem}{>{\TrimSpaces}m}{\item #1}

% Ambiente "enumerate" especial utilizado no dicionário, coloca os exemplos
% das definições do verbete em uma lista numerada em linha, utilizando
% algarismos romanos
\makeatletter
\NewDocumentCommand{\dictexamples}{m>{\SplitList{|}}m}
 {%
  \def\@theword{#1}%
  \begin{enumerate}[nosep,label=(\roman*),left=0pt,mode=unboxed,font=\bfseries]
   \ProcessList{#2}{\insertexample}
  \end{enumerate}
 }
\NewDocumentCommand{\insertexample}{>{\TrimSpaces}m}
 {
  \IfSubStr{#1}{mud::::}
   {% Sublinhado Manual
    \StrBehind{#1}{mud::::}[output]%
    \IfSubStr{\output}{___}
    {% Com traducao
     \StrCut{\output}{___}\csA\csB%
     \item\csA\\{\small``\csB''}
    }
    {% Sem traducao
     \item\output
    }
   }
   {% Sublinhado Automático
    \IfSubStr{#1}{___}
    {% Com traducao
      \StrCut{#1}{___}\csA\csB%
      \item\StrSubstitute{\csA}{\@theword}{\underline{\@theword}}\\{\small``\csB''}
    }
    {% Sem traducao
      \item\StrSubstitute{#1}{\@theword}{\underline{\@theword}}
    }
   }
 }  
\makeatother

\ExplSyntaxOn

%%% Cria listas especializadas (seelist e seealsolist)
\newlist{seelist}{enumerate}{1}
\newlist{seealsolist}{enumerate}{1}

\setlist[seelist]{label={(\alph*)},topsep=0pt,nosep,noitemsep}%,leftmargin=\parindent}
\setlist[seealsolist]{label={(\alph*)},topsep=0pt,nosep,noitemsep}%,leftmargin=\parindent}

%%% Cria e inicializa a lista "\seerefl", "Veja"
\newcommand\seerefl{}
\listadd{\seerefl}{}% Inicializa a lista

%%% Cria e inicializa a lista "\seealsorefl", "Veja também"
\newcommand\seealsorefl{}
\listadd{\seealsorefl}{}% Inicializa a lista

%%% Comando "\seeitem", adiciona um item "Veja" ou "Veja também" na lista,
%%% com os pinyins abaixo dos caracteres
\newcommand{\seeitem}[2]{#1~\dpy{#2}\ (p.~\pageref{#1:#2})}

%%% Comando "\definition", gera o texto da definição
\NewDocumentCommand{\definition}{sommo}
 {%
  \IfBooleanTF{#1}%
   {% Substantivo Próprio
    {\small\ding{108}}\ (\textit{S.P.})\IfValueT{#2}{~[clas.:~#2]}{\ \dictenumerate{#4}}\par
   }%
   {%
    {\small\ding{108}}\ (\textit{#3})\IfValueT{#2}{~[clas.: #2]}{\ \dictenumerate{#4}}\par
   }%
  \IfValueT{#5}%
   {%
    \IfSubStr{#5}{|}{\textbf{Exemplos:}}{\textbf{Exemplo:}}\dictexamples{\l_hanzi_tl}{#5}
   }%
 }

%%% Comando "Variante de"
\NewDocumentCommand{\variantof}{m}
 {
  {\small\ding{108}}\ Variante\ de\ #1\ (p.~\pageref{#1:\l_pinyin_tl})\par
 }

%%% Comando "Veja"
\NewDocumentCommand{\seeref}{mm}
 {%
  \booltrue{f_see}
  \listgadd{\seerefl}{#1:#2}
 }

%%% Comando "Veja também"
\NewDocumentCommand{\seealsoref}{mm}
 {%
  \booltrue{f_seealso}
  \listgadd{\seealsorefl}{#1:#2}
 }

\ExplSyntaxOff

%%%%% EOF %%%%%
